const modal = document.getElementById('task-modal');
const inputTask = document.getElementById('input-task');
const inputDate = document.getElementById('input-datetime');
const sound = document.getElementById('success-sound');

// INICIALIZAÇÃO DO GRÁFICO (Chart.js)
const ctx = document.getElementById('taskChart').getContext('2d');
let taskChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: ['A Fazer', 'Fazendo', 'Feito'],
        datasets: [{
            data: [0, 0, 0],
            backgroundColor: ['#fbbf24', '#38bdf8', '#22c55e'],
            borderWidth: 0,
            hoverOffset: 4
        }]
    },
    options: {
        plugins: { legend: { display: false } },
        cutout: '70%'
    }
});

function openModal() { modal.style.display = 'grid'; inputTask.focus(); }
function closeModal() { modal.style.display = 'none'; inputTask.value = ''; inputDate.value = ''; }

function handleEnter(event) { if (event.key === 'Enter') createNewTask(); }

function allowDrop(ev) { ev.preventDefault(); }
function drag(ev) { ev.dataTransfer.setData("text", ev.target.id); }

function drop(ev) {
    ev.preventDefault();
    const data = ev.dataTransfer.getData("text");
    const targetColumn = ev.target.closest('.kanban-column');
    const dropzone = targetColumn.querySelector('.task-zone');
    dropzone.appendChild(document.getElementById(data));
    
    if (targetColumn.id === 'done') {
        sound.currentTime = 0;
        sound.play();
    }
    updateCounts();
}

function createNewTask() {
    if (inputTask.value.trim() === "") return;

    const id = 'task-' + Date.now();
    const dateValue = inputDate.value ? new Date(inputDate.value).toLocaleString('pt-BR') : 'Sem prazo';
    
    const task = document.createElement('div');
    task.className = 'task-card';
    task.id = id;
    task.draggable = true;
    task.ondragstart = drag;

    task.innerHTML = `
        <div class="task-content">
            <p>${inputTask.value}</p>
            <i class="fas fa-trash delete-icon" onclick="removeTask('${id}')"></i>
        </div>
        <div class="task-date">
            <i class="far fa-clock"></i> ${dateValue}
        </div>
    `;

    document.getElementById('todo-list').appendChild(task);
    closeModal();
    updateCounts();
}

function removeTask(id) {
    document.getElementById(id).remove();
    updateCounts();
}

function updateCounts() {
    const todo = document.getElementById('todo-list').children.length;
    const doing = document.getElementById('doing-list').children.length;
    const done = document.getElementById('done-list').children.length;

    document.getElementById('todo-count').innerText = todo;
    document.getElementById('doing-count').innerText = doing;
    document.getElementById('done-count').innerText = done;

    // Atualiza os dados do gráfico
    taskChart.data.datasets[0].data = [todo, doing, done];
    taskChart.update();
}
